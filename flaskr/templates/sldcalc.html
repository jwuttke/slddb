{% extends 'base.html' %}

{% block nav_calculate_sld %}active{% endblock %}

{% block content %}
  {% if material %}
    <script>
    var material_energies = {{ xray_E }};
    var material_delta_real = {{ xray_delta_real }};
    var material_delta_imag = {{ xray_delta_imag }};

    var material_neutron_real = {{1000000*material.rho_n.real}};
    var material_neutron_imag = {{1000000*material.rho_n.imag}};
    var material_neutron_magn = {{1000000*material.rho_m.real}};
    var material_Cu_real = {{1000000*material.delta_of_E(Cu_kalpha).real}};
    var material_Cu_imag = {{1000000*material.delta_of_E(Cu_kalpha).imag}};
    var material_Mo_real = {{1000000*material.delta_of_E(Mo_kalpha).real}};
    var material_Mo_imag = {{1000000*material.delta_of_E(Mo_kalpha).imag}};

    var can_switch=true;

    function updateSlider(slideAmount) {
        var unit = document.getElementById("user_select").value;
        if (slideAmount<0) {
            slideAmount=document.getElementById("xray_energy_value").value;
            if (can_switch) {
                can_switch=false;
                document.getElementById("cu_select").selectedIndex=document.getElementById("user_select").selectedIndex;
                document.getElementById("mo_select").selectedIndex=document.getElementById("user_select").selectedIndex;
                switch_sld_cu(unit)
                switch_sld_mo(unit)
                can_switch=true;
            }
            }
        var factor; var val_real; var val_imag;
        var xval=parseFloat(slideAmount)/1000.0;
        var left = material_energies.findIndex(ele => ele >= xval);
        var right = left+1;
        var dxleft = material_energies[left]-xval;
        var dxright = xval-material_energies[right];
        var dx=dxleft+dxright;
        if (dxleft>0) {
            val_real=material_delta_real[left]*(dxright/dx)+material_delta_real[right]*(dxleft/dx);
            val_imag=material_delta_imag[left]*(dxright/dx)+material_delta_imag[right]*(dxleft/dx);
        } else {
            val_real=material_delta_real[left];
            val_imag=material_delta_imag[left];
        }

        if (unit == 'sld') {
            factor=1e6;
        } else {
            factor=100000./{{r_e}};
        }

        document.getElementById("value_real").innerHTML = (val_real*factor).toFixed(6);
        document.getElementById("value_imag").innerHTML = (val_imag*factor).toFixed(6);

        document.getElementById("xray_energy_value").value = slideAmount;
    }

    function updateValue() {
        const value = document.getElementById("xray_energy_value").value;
        document.getElementById("xray_energy").value = value;
        updateSlider(value);
    }

    function copy_all() {
        var out = '';
        out=out.concat('Compound', '\t', '{{material_name}}', '\n');
        out=out.concat('Description', '\t', '{{material_description}}', '\n');
        out=out.concat('Chemical Formula', '\t', '{{material}}', '\n');

        var dens_select=document.getElementById("densresult")
        out=out.concat(dens_select.options[dens_select.selectedIndex].text, '\t',
                        document.getElementById("density_value").innerHTML, '\n');

        out=out.concat('', '\t', 'real', '\t', 'imag', '\n');
        out=out.concat('Neutron nuclear SLD (10⁻⁶ Å⁻²)',
                        '\t', '{{"%.6f"%(1000000*material.rho_n.real)}}',
                        '\t', '{{"%.6f"%(1000000*material.rho_n.imag)}}', '\n');
        out=out.concat('Neutron magnetic SLD (10⁻⁶ Å⁻²)', '\t', '{{"%.6f"%(1000000*material.rho_m)}}', '\n');

        var xray_select=document.getElementById("cu_select");
        var xray_unit=xray_select.options[xray_select.selectedIndex].text
        out=out.concat(`Cu-Kɑ ${xray_unit}`,
                        '\t', document.getElementById("cu_entry_real").innerHTML,
                        '\t', document.getElementById("cu_entry_imag").innerHTML, '\n');
        out=out.concat(`Mo-Kɑ SLD ${xray_unit}`,
                        '\t', document.getElementById("mo_entry_real").innerHTML,
                        '\t', document.getElementById("mo_entry_imag").innerHTML, '\n');
        out=out.concat(`Custom (${document.getElementById("xray_energy_value").value} eV) ${xray_unit}`,
                        '\t', document.getElementById("value_real").innerHTML,
                        '\t', document.getElementById("value_imag").innerHTML, '\n');

        navigator.clipboard.writeText(out);
    }

    function copy_NSLD() {
        navigator.clipboard.writeText(`${material_neutron_real.toFixed(6)}+${material_neutron_imag.toFixed(6)}j`.replace('+-', '-'));
    }
    function copy_Nmag() {
        navigator.clipboard.writeText(`${material_neutron_magn.toFixed(6)}`);
    }
    function copy_Cu() {
        var value_real=Number(document.getElementById("cu_entry_real").innerHTML);
        var value_imag=Number(document.getElementById("cu_entry_imag").innerHTML);
        navigator.clipboard.writeText(`${value_real.toFixed(6)}+${value_real.toFixed(6)}j`.replace('+-', '-'));
    }
    function copy_Mo() {
        var value_real=Number(document.getElementById("mo_entry_real").innerHTML);
        var value_imag=Number(document.getElementById("mo_entry_imag").innerHTML);
        navigator.clipboard.writeText(`${value_real.toFixed(6)}+${value_real.toFixed(6)}j`.replace('+-', '-'));
    }
    function copy_xray() {
        const SLD_real=document.getElementById("value_real").innerHTML;
        const SLD_imag=document.getElementById("value_imag").innerHTML;
        navigator.clipboard.writeText(`${SLD_real}+${SLD_imag}j`.replace('+-', '-'));
    }

    function switch_density() {
        var selection = document.getElementById("densresult").value;
        if (selection == 'density') {document.getElementById("density_value").innerHTML = '{{"%.4f"%material.dens}}';}
        if (selection == 'FUdens') {document.getElementById("density_value").innerHTML = '{{"%.4f"%material.fu_dens}}';}
        if (selection == 'FUdnm') {document.getElementById("density_value").innerHTML = '{{"%.4f"%(material.fu_dens*1e3)}}';}
        if (selection == 'volume') {document.getElementById("density_value").innerHTML = '{{"%.4f"%material.fu_volume}}';}
    }

    function switch_sld_cu(selection) {
        if (selection == 'electron') {
            document.getElementById("cu_entry_real").innerHTML = '{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).real)}}';
            document.getElementById("cu_entry_imag").innerHTML = '{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).imag)}}';
            }
        if (selection == 'sld') {
            document.getElementById("cu_entry_real").innerHTML = '{{"%.6f"%(1e6*material.delta_of_E(Cu_kalpha).real)}}';
            document.getElementById("cu_entry_imag").innerHTML = '{{"%.6f"%(1e6*material.delta_of_E(Cu_kalpha).imag)}}';
            }
        if (can_switch) {
            can_switch=false;
            document.getElementById("mo_select").selectedIndex=document.getElementById("cu_select").selectedIndex;
            switch_sld_mo(selection)
            document.getElementById("user_select").selectedIndex=document.getElementById("cu_select").selectedIndex;
            updateSlider(-1)
            can_switch=true;
        }
    }

    function switch_sld_mo(selection) {
        if (selection == 'electron') {
            document.getElementById("mo_entry_real").innerHTML = '{{"%.6f"%(1e5/r_e*material.delta_of_E(Mo_kalpha).real)}}';
            document.getElementById("mo_entry_imag").innerHTML = '{{"%.6f"%(1e5/r_e*material.delta_of_E(Mo_kalpha).imag)}}';
            }
        if (selection == 'sld') {
            document.getElementById("mo_entry_real").innerHTML = '{{"%.6f"%(1e6*material.delta_of_E(Mo_kalpha).real)}}';
            document.getElementById("mo_entry_imag").innerHTML = '{{"%.6f"%(1e6*material.delta_of_E(Mo_kalpha).imag)}}';
            }
        if (can_switch) {
            can_switch=false;
            document.getElementById("cu_select").selectedIndex=document.getElementById("mo_select").selectedIndex;
            switch_sld_cu(selection)
            document.getElementById("user_select").selectedIndex=document.getElementById("mo_select").selectedIndex;
            updateSlider(-1)
            can_switch=true;
        }
    }
    </script>
  {% endif %}

  <p><center>
    <form action="{{ url_for('calculate_sld') }}" method="get">
      <table class="withborder">
        <tr><td>Field</td><td>value for calculation</td></tr>
        <tr><td>Formula</td><td><input name="formula" id="compound formula" value="{{ request.args['formula'] or formula }}"></td></tr>
        <tr><td><select id="densinput" name="densinput">
          <option value="density">Density (g/cm³)</option>
          <option value="volume">FU Volume (Å³)</option>
        </select></td><td><input type='number' step="0.00001" name="density" id="compound density" value="{{ request.args['density'] or density }}"></td></tr>
        <tr><td>Magnetisation (µB/FU)</td><td><input type='number' step="0.00001" name="mu" id="compound mu" value="{{ request.args['mu'] or mu }}"></td></tr>
        <tr><td colspan="2"><center><input type="submit"></center></td> </tr>
      </table>
    </form>
    </center>
  </p>

  <p><center>
    <form action="{{ url_for('start_page') }}">
      <button type="submit" >back to database query</button>
    </form>
    </center>
  </p>

  {% if material %}
  <p><center>
  <h2>Result of SLD calculation:</h2>
    <table class="withborder"{% if validated %} style="background-color: #dfd"{% endif %}>
        <tr><td>Compound</td><td colspan=3>{{material_name}}</td></tr>
        <tr><td>Description</td><td colspan=2 syle="word-wrap;">{{material_description}}</td>
            <td rowspan="3"><center><button type="button" onclick="copy_all()">Copy to<br />Clipboard</button></center></td></tr>
        <tr><td>Chemical Formula</td><td colspan=2>{{material}}</td></tr>
        <tr><td><select id="densresult" name="densresult" onchange="switch_density()">
          <option value="density">Density (g/cm³)</option>
          <option value="FUdens">Density (FU/Å³)</option>
          <option value="FUdnm">Density (FU/nm³)</option>
          <option value="volume">FU Volume (Å³)</option>
        </select></td><td colspan=2 id="density_value">{{"%.4f"%material.dens}}</td></tr>
        <tr><td>Neutron nuclear SLD (10⁻⁶ Å⁻²)</td>
          <td>{{"%.6f"%(1000000*material.rho_n.real)}}</td>
          <td>{{"%.6f"%(1000000*material.rho_n.imag)}}</td>
          <td><button type="button" onclick="copy_NSLD()">as Complex</button></td></tr>
        <tr><td>Neutron magnetic SLD (10⁻⁶ Å⁻²)</td><td colspan=2>{{"%.6f"%(1000000*material.rho_m)}}</td>
            <td><button type="button" onclick="copy_Nmag()">as Float</button></td></tr>
        <tr><td>Cu-Kɑ <select id="cu_select" name="cu_select" onchange="switch_sld_cu(this.value)">
                <option value="electron">electrons (rₑ/Å³)</option>
                <option value="sld">SLD (10⁻⁶ Å⁻²)</option>
                </select></td>
          <td id="cu_entry_real">{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).real)}}</td>
          <td id="cu_entry_imag">{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).imag)}}</td>
          <td><button type="button" onclick="copy_Cu()">as Complex</button></td></tr>
        <tr><td>Mo-Kɑ <select id="mo_select" name="mo_select" onchange="switch_sld_mo(this.value)">
                <option value="electron">electrons (rₑ/Å³)</option>
                <option value="sld">SLD (10⁻⁶ Å⁻²)</option>
                </select></td>
          <td id="mo_entry_real">{{"%.6f"%(1e5/r_e*material.delta_of_E(Mo_kalpha).real)}}</td>
          <td id="mo_entry_imag">{{"%.6f"%(1e5/r_e*material.delta_of_E(Mo_kalpha).imag)}}</td>
          <td><button type="button" onclick="copy_Mo()">as Complex</button></td></tr>
        <tr><td>Custom Energy (eV)</td>
          <td colspan="2"><select id="user_select" name="user_select" onchange="updateSlider(-1)">
                <option value="electron">electrons (rₑ/Å³)</option>
                <option value="sld">SLD (10⁻⁶ Å⁻²)</option>
                </select></td></tr>
        <tr><td><form action="" onsubmit="return false;">
            <input type="range" min="100" max="30000" value="8040" class="slider" id="xray_energy" step="20" onchange="updateSlider(this.value)">
            <input type="number" min="100" max="30000" value="8040" class="slider_value" id="xray_energy_value" onchange="updateValue(this.value)">
            </form></td>
            <td><div id="value_real">{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).real)}}</div></td>
            <td><div id="value_imag">{{"%.6f"%(1e5/r_e*material.delta_of_E(Cu_kalpha).imag)}}</div></td>
            <td><button type="button" onclick="copy_xray()">as Complex</button></td></tr>
        {% if validated %}
        <tr><td colspan="3">This entry was validated by ORSO<br />({{ validated }} by {{ validated_by }})</td></tr>
        {% endif %}
    </table>
  </center></p>
  {% endif %}

  <center>
  {{script|safe}}
  </center>

{% endblock %}
